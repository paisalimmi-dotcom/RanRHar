# RanRHar — การจัดการโต๊ะลูกค้าและ UX แบบ Best Practice

**Version:** 1.0  
**วันที่:** 2026-02-08  
**เป้าหมาย:** ให้ร้านและทีมรู้วิธีจัดการโต๊ะ สั่งซ้ำ แจ้งลูกค้า และข้อควรปฏิบัติ

---

## 1. สถานะปัจจุบันของระบบ

### 1.1 สิ่งที่มีอยู่แล้ว

| รายการ | สถานะ | หมายเหตุ |
|--------|--------|----------|
| ลูกค้าเห็นเลขโต๊ะ | ✅ | โชว์บนเมนู "โต๊ะ A12" |
| ส่ง tableCode ตอนสั่ง | ✅ | ส่งใน POST /orders/guest |
| เจ้าหน้าที่เห็นเลขโต๊ะ | ❌ | **ยังไม่เก็บใน DB** — เจ้าหน้าที่ไม่รู้ว่าโต๊ะไหนสั่ง |
| แจ้งสถานะลูกค้า | ❌ | ลูกค้าไม่รู้ว่าอาหารรอทำ/กำลังทำ/เสร็จแล้ว |
| ป้องกันสั่งซ้ำ | △ | มี Idempotency-Key แต่ไม่บังคับใช้ |

### 1.2 ช่องว่างที่ต้องแก้

| ช่องว่าง | ความสำคัญ | วิธีแก้ |
|----------|-----------|---------|
| เก็บ `table_code` ใน orders | **สูง** | เพิ่ม column ใน DB และ migrate |
| แสดงเลขโต๊ะใน Orders/KDS | สูง | หลังเก็บ table_code แล้ว |
| แจ้งสถานะลูกค้า | ปานกลาง | หน้า Order Status หรือ polling |
| แจ้งเตือนสั่งซ้ำ | ปานกลาง | ตรวจสอบก่อน Place Order |

---

## 2. การจัดการโต๊ะ — Best Practice

### 2.1 โครงสร้างที่ควรเป็น

```
┌─────────────────────────────────────────────────────────────────┐
│  QR Code บนโต๊ะ → /menu/A12  (แต่ละโต๊ะมี URL ไม่ซ้ำกัน)          │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  ลูกค้าโต๊ะ A12 สั่งอาหาร → order เก็บ table_code = "A12"          │
│  ลูกค้าโต๊ะ B05 สั่งอาหาร → order เก็บ table_code = "B05"          │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  เจ้าหน้าที่/KDS เห็น: ออเดอร์ #123 → โต๊ะ A12                    │
│  พนักงานเสิร์ฟนำอาหารไปโต๊ะ A12 ได้ถูกต้อง                         │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 แนวทางปฏิบัติ

| สถานการณ์ | แนวทางปฏิบัติ |
|-----------|----------------|
| **หลายคนหลายโต๊ะ** | แต่ละโต๊ะมี QR หรือ URL แยก (เช่น `/menu/A12`, `/menu/B05`) |
| **คนเดียวกันหลายโต๊ะ** | ใช้ QR แยกตามโต๊ะ — จะได้ไม่สับสน |
| **โต๊ะย้าย** | ควรให้สั่งจาก QR ที่โต๊ะใหม่ — หรือเพิ่มระบบแจ้งย้ายโต๊ะ |
| **รวมบิลหลายโต๊ะ** | อนาคต: ฟีเจอร์ "รวมบิล" — ตอนนี้ต้องแยกชำระ |

### 2.3 ปัญหา: ลูกค้าสั่งอาหารแล้วไปสแกน QR โต๊ะอื่น

#### สถานการณ์ปัญหา
```
ลูกค้าอยู่ที่โต๊ะ A12 → สั่งอาหารไปแล้ว (ออเดอร์ #1)
↓
ลูกค้าเผลอไปสแกน QR Code ของโต๊ะ B05
↓
สั่งอาหารเพิ่ม (ออเดอร์ #2 จากโต๊ะ B05)
↓
ปัญหา: เจ้าหน้าที่จะนำอาหารไปผิดโต๊ะ!
```

#### วิธีแก้ไข

| วิธี | ความยาก | ผล | แนะนำ |
|------|----------|-----|--------|
| **1. ตรวจสอบและเตือน** | ง่าย | ถ้าเคยสั่งจากโต๊ะอื่น → แสดงเตือน "คุณเคยสั่งจากโต๊ะ A12" | ✅ **แนะนำ** |
| **2. ยืนยันก่อนสั่ง** | ง่าย | ถ้า tableCode เปลี่ยน → ถาม "ยืนยันว่าเปลี่ยนโต๊ะ?" | ✅ **แนะนำ** |
| **3. แสดงโต๊ะปัจจุบันชัดเจน** | ง่าย | แสดง "คุณอยู่ที่โต๊ะ B05" และเตือนถ้าเปลี่ยน | ✅ **แนะนำ** |
| **4. รวมออเดอร์อัตโนมัติ** | กลาง | ถ้าเป็นลูกค้าเดียวกัน → รวมออเดอร์ไปโต๊ะเดิม | △ (ต้องระวัง) |
| **5. ล็อก tableCode** | กลาง | หลังสั่งครั้งแรก → ล็อก tableCode ไม่ให้เปลี่ยน | △ (อาจไม่สะดวก) |

#### แนวทางที่แนะนำ (รวมหลายวิธี)

**วิธีที่ 1: ตรวจสอบและเตือน (แนะนำ)**
```
ลูกค้าเปิด /menu/B05
        │
        ▼
┌─────────────────────────────────────┐
│ ตรวจสอบ: มีออเดอร์ล่าสุดจากโต๊ะอื่น? │
│ - ถ้ามี → แสดงเตือน                  │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ แสดงเตือน:                          │
│ "⚠️ คุณเคยสั่งอาหารจากโต๊ะ A12        │
│  ต้องการสั่งเพิ่มที่โต๊ะ B05 หรือไม่? │
│  หรือกลับไปโต๊ะ A12?"                │
│                                      │
│  [สั่งที่ B05] [กลับไป A12]          │
└─────────────────────────────────────┘
```

**วิธีที่ 2: ยืนยันก่อน Place Order**
```
ลูกค้ากด "Place Order" ที่โต๊ะ B05
        │
        ▼
┌─────────────────────────────────────┐
│ ถ้า tableCode เปลี่ยนจากออเดอร์ล่าสุด: │
│                                      │
│ "⚠️ คุณกำลังสั่งอาหารไปที่โต๊ะ B05     │
│  แต่คุณเคยสั่งจากโต๊ะ A12              │
│                                      │
│  ยืนยันว่าต้องการสั่งที่โต๊ะ B05?"   │
│                                      │
│  [ยืนยัน] [ยกเลิก]                   │
└─────────────────────────────────────┘
```

**วิธีที่ 3: แสดงโต๊ะปัจจุบันชัดเจน**
```
┌─────────────────────────────────────┐
│ หน้าเมนูแสดง:                        │
│                                      │
│ 📍 โต๊ะปัจจุบัน: B05                 │
│                                      │
│ ⚠️ คุณเคยสั่งจากโต๊ะ A12              │
│    [ดูออเดอร์ A12] [สั่งที่ B05]     │
└─────────────────────────────────────┘
```

#### ✅ แนวทางที่เลือก (ลูกค้าสบายใจ + ระบบไม่เป็นปัญหา)

**เลือกใช้: วิธีที่ 3 + วิธีที่ 2 (รวมกัน)**

1. **แสดงโต๊ะปัจจุบันชัดเจน** (ไม่รบกวน)
   - แสดง "โต๊ะ B05" บนเมนูเสมอ
   - ถ้ามีออเดอร์ล่าสุดจากโต๊ะอื่น → แสดงแถบเตือนเล็กๆ "คุณเคยสั่งจากโต๊ะ A12"

2. **ยืนยันก่อน Place Order** (ป้องกันปัญหา)
   - ถ้า tableCode เปลี่ยนจากออเดอร์ล่าสุด → แสดง modal ยืนยัน
   - ถ้า tableCode เดิม → สั่งได้เลย (ไม่รบกวน)

**เหตุผลที่เลือก:**
- ✅ **ไม่รบกวน** - ถ้าไม่เปลี่ยนโต๊ะ สั่งได้เลย
- ✅ **ป้องกันปัญหา** - ถ้าเปลี่ยนโต๊ะ มีการยืนยัน
- ✅ **Implementation ง่าย** - ใช้ sessionStorage + modal
- ✅ **UX ดี** - ลูกค้าเห็นโต๊ะชัดเจน และยืนยันเมื่อจำเป็น

#### Implementation ที่แนะนำ

1. **เก็บ `lastOrderTableCode` ใน sessionStorage** - หลังสั่งสำเร็จ เก็บ tableCode
2. **แสดงโต๊ะปัจจุบันชัดเจน** - แสดง "โต๊ะ B05" บนเมนูเสมอ
3. **แสดงแถบเตือน** - ถ้ามี `lastOrderTableCode` และไม่ตรงกับโต๊ะปัจจุบัน → แสดงแถบเตือนเล็กๆ
4. **ยืนยันก่อน Place Order** - ถ้า tableCode เปลี่ยน → แสดง modal ยืนยัน

#### ข้อมูลที่ต้องเก็บ

| ข้อมูล | เก็บที่ไหน | ใช้สำหรับ |
|--------|------------|-----------|
| `lastOrderTableCode` | sessionStorage หรือ localStorage | ตรวจสอบว่าเคยสั่งจากโต๊ะไหน |
| `currentTableCode` | URL parameter | โต๊ะปัจจุบันที่เปิดเมนู |
| `orderHistory` | API หรือ localStorage | ดูออเดอร์ล่าสุด |

#### กรณีพิเศษ: ลูกค้าต้องการย้ายโต๊ะจริงๆ

- ถ้าลูกค้ายืนยันว่าเปลี่ยนโต๊ะ → ให้สั่งได้ แต่ควรแจ้งเจ้าหน้าที่
- หรือให้เจ้าหน้าที่ช่วยย้ายออเดอร์ไปโต๊ะใหม่ (อนาคต)

### 2.4 ลูกค้าควรเห็นอะไร

| ข้อมูล | ควรมี | เหตุผล |
|--------|--------|--------|
| เลขโต๊ะ | ✅ | ยืนยันว่าโต๊ะถูก |
| สรุปออเดอร์ก่อนสั่ง | ✅ | มีอยู่แล้ว |
| เลขออเดอร์หลังสั่ง | ✅ | มีอยู่แล้ว |
| สถานะออเดอร์ (รอทำ/กำลังทำ/เสร็จแล้ว) | ✅ แนะนำ | ลูกค้าได้รู้ว่าอาหารถึงไหน |
| แจ้งเตือนสั่งซ้ำ | ✅ แนะนำ | ลดโอกาสกดซ้ำโดยไม่ตั้งใจ |

---

## 3. การสั่งซ้ำ — วิธีจัดการ

### 3.1 สาเหตุที่สั่งซ้ำ

1. กด "Place Order" ซ้ำ
2. เปิดหลายแท็บแล้วสั่งซ้ำ
3. หลายคนที่โต๊ะกันสั่งรวมกัน

### 3.2 วิธีป้องกัน

| วิธี | ความยาก | ผล |
|------|----------|-----|
| **Idempotency-Key** | ✅ มีอยู่ | ป้องกัน duplicate request ถ้าใช้ key เดียวกัน |
| **ปุ่มสั่ง disable หลังกด** | ✅ มี | ปุ่มสั่ง disable ระหว่างสั่ง |
| **แสดงข้อความ "กำลังสั่ง..."** | ✅ มี | ลดโอกาสกดซ้ำ |
| **แจ้ง "สั่งซ้ำหรือไม่?"** | ง่าย | ถ้าตะกร้าเหมือนกับออเดอร์ล่าสุด |
| **แจ้ง "ออเดอร์ล่าสุดยังไม่เสร็จ"** | กลาง | ถ้าโต๊ะเดียวกันมีออเดอร์ PENDING |

### 3.3 แนวทางที่แนะนำ

- **ก่อน Place Order:** แสดง confirmation "สั่ง 5 รายการ รวม ฿450" ให้ชัดเจน
- **หลัง Place Order:** redirect ไปหน้า success ทันที พร้อมแสดงข้อความ "กำลังจัดเตรียมอาหาร"
- **ไม่ให้สั่งซ้ำง่าย:** หลังสั่งสำเร็จ ตะกร้าว่าง และ redirect ไม่กลับไปกดซ้ำได้ง่าย

---

## 4. แจ้งลูกค้า — UX ที่ดี

### 4.1 สิ่งที่ควรแจ้งลูกค้า

| จุด | แจ้งอะไร | วิธี |
|-----|----------|------|
| หลังสั่งสำเร็จ | เลขออเดอร์ และ "กำลังจัดเตรียมอาหาร" | หน้า Order Success |
| ระหว่างรอ | สถานะ: รอทำ/กำลังทำ/เสร็จแล้ว | หน้า Order Status หรือ polling |
| เมื่ออาหารพร้อม | "อาหารพร้อมแล้ว" | แจ้งหรือ refresh หน้า |
| เมื่อมีปัญหา | "เมนู X ไม่พร้อม" หรือขอโทษ | ข้อความหรือแจ้งผ่านพนักงาน |

### 4.2 หน้า Order Status (แนะนำ)

- URL: `/order/status/[orderId]` หรือ `/order/status/[orderId]?table=A12`
- แสดง: เลขออเดอร์, รายการ, สถานะ, เลขโต๊ะ
- อัปเดต: ทุก 30 วินาที หรือ WebSocket

### 4.3 สิทธิ์การตรวจสอบ

- ลูกค้าไม่ login — ต้องมีวิธีตรวจสอบ เช่น `orderId + tableCode`
- ไม่ต้องให้ข้อมูลส่วนตัวมากเกินไป

---

## 5. แผนการดำเนินการ (แนะนำ)

### Phase 1: เก็บและแสดงเลขโต๊ะ ( urgent )

1. เพิ่ม column `table_code` ในตาราง `orders`
2. ส่ง tableCode ไปเก็บใน DB ตอนสร้าง guest order
3. GET /orders คืน tableCode ให้ด้วย
4. หน้า Orders และ KDS แสดงเลขโต๊ะ

### Phase 2: หน้า Order Status สำหรับลูกค้า

1. สร้าง `/order/status/[id]` รับ query `?table=A12`
2. ถ้า tableCode ตรงกับ order ถึงแสดงข้อมูล
3. แสดงสถานะออเดอร์และอัปเดตทุก 30 วินาที
4. ลิงก์จากหน้า Order Success

### Phase 3: ปรับปรุงการสั่งซ้ำ

1. ใช้ Idempotency-Key ใน frontend
2. อาจแจ้งเตือนเมื่อโต๊ะเดียวกันมีออเดอร์ PENDING

---

## 6. การยกเลิกออเดอร์ (Cancel Order)

### 6.1 นโยบายปกติ

| สถานะออเดอร์ | Cancel ได้หรือไม่ | ผู้ที่ Cancel ได้ | เหตุผล |
|---------------|-------------------|-------------------|--------|
| **PENDING** (รอทำ) | ✅ **ได้** | ลูกค้า, เจ้าหน้าที่, ผู้จัดการ | ยังไม่ได้ทำอาหาร |
| **CONFIRMED** (กำลังทำ) | ❌ **ไม่ได้** | - | ครัวเริ่มทำแล้ว |
| **COMPLETED** (เสร็จแล้ว) | ❌ **ไม่ได้** | - | ทำเสร็จแล้ว |
| **PAID** (ชำระแล้ว) | ❌ **ไม่ได้** | - | กินเสร็จ + ชำระแล้ว |

### 6.2 กรณีพิเศษ — ผู้จัดการเท่านั้น

| สถานการณ์ | ผู้ดำเนินการ | เงื่อนไข | หมายเหตุ |
|-----------|-------------|----------|----------|
| **อาหารมีปัญหา** (คุณภาพไม่ดี, ไม่ถูกต้อง, เสียหาย) | **ผู้จัดการ** | พิจารณาแล้วต้องยกเลิก | Cancel ได้แม้ CONFIRMED/COMPLETED |
| **ต้องทำให้ใหม่** | **ผู้จัดการ** | อาหารมีปัญหา ต้องทำใหม่ | Cancel ออเดอร์เดิม → สร้างออเดอร์ใหม่ |
| **ลูกค้าไม่พอใจ** | **ผู้จัดการ** | พิจารณาแล้วต้องยกเลิก | Cancel + Refund (ถ้าชำระแล้ว) |

### 6.3 ขั้นตอนการ Cancel

#### กรณีปกติ (PENDING)
```
ลูกค้า/เจ้าหน้าที่ ขอ Cancel
        │
        ▼
┌─────────────────────────────────────┐
│ ตรวจสอบ: status === 'PENDING'       │
│ ✅ Cancel ได้ทันที                   │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ อัปเดต: status = 'CANCELLED'        │
│ Audit log: order.cancel             │
└─────────────────────────────────────┘
```

#### กรณีพิเศษ (Manager)
```
พบปัญหาอาหาร → แจ้งผู้จัดการ
        │
        ▼
┌─────────────────────────────────────┐
│ ผู้จัดการพิจารณา                     │
│ - อาหารมีปัญหา?                      │
│ - ต้องยกเลิก?                        │
│ - ต้องทำให้ใหม่?                     │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ ผู้จัดการ Cancel (แม้ CONFIRMED/     │
│ COMPLETED)                          │
│ - เก็บเหตุผล (reason)                │
│ - Audit log: order.cancel_by_manager│
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ ถ้าชำระแล้ว → Refund                 │
│ ถ้าต้องทำใหม่ → สร้างออเดอร์ใหม่      │
└─────────────────────────────────────┘
```

### 6.4 สิ่งที่ต้องเก็บในระบบ

| ข้อมูล | จำเป็น | ใช้สำหรับ |
|--------|--------|-----------|
| `cancelled_at` | ✅ | เวลาที่ Cancel |
| `cancelled_by` | ✅ | ใคร Cancel (user_id) |
| `cancel_reason` | ✅ | เหตุผล (ปกติ/ปัญหา) |
| `refund_required` | ✅ | ต้อง Refund หรือไม่ |

---

## 7. สรุปข้อควรปฏิบัติ

| หัวข้อ | ข้อควรปฏิบัติ |
|--------|----------------|
| **การจัดการโต๊ะ** | เก็บ table_code ใน DB และแสดงให้เจ้าหน้าที่เห็นใน Orders/KDS |
| **การสั่งซ้ำ** | ใช้ Idempotency-Key, ปุ่ม disable หลังกด, แสดง confirmation |
| **แจ้งลูกค้า** | แจ้งสถานะออเดอร์ (รอทำ/กำลังทำ/เสร็จแล้ว) ในหน้า Order Status |
| **การยกเลิกออเดอร์** | Cancel ได้เฉพาะ PENDING (ปกติ) หรือ Manager Cancel ในกรณีพิเศษ |
| **การรวมบิล** | อนาคต — ตอนนี้แยกชำระตามโต๊ะ |
| **QR Code** | ควรให้ eachโต๊ะมี QR หรือ URL แยกกัน |

---

*เอกสารนี้อ้างอิงจาก ROLES_ALL.md และ flow ปัจจุบันของ RanRHar*
